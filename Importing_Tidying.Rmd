---
title: "Research_Paper_Code"
author: "aaron till"
date: "5/24/2018"
output: html_document
---


```{r installing packages}
library(ggplot2)
library(gridExtra)
library(dplyr)
library(randomForest)
library(tidyr)
library(stringr)
library(lubridate)
library(ggthemes)
library(ggmap)
library(rgdal)

```

```{r uploading and editing MME data}

MME_raw <-read.csv("/home/aatill/Till_Thesis/Summer_Research_Work/Data/Fish Kill Data Updated 5_24_2018.csv")

MME_filtered <- MME_raw %>%
  filter(Min.Kill.Size!="Excludable") %>%
  select(-contains('County'), -contains('Station.Name'), -contains('Cause.Desc'), -contains('Site.Seq.No'), -contains('Fishkill.Inv.Seq.No'), - contains('Location.QA.Comment'), -contains('Activity.Desc'), -contains('Recommended.Action.Desc'), -contains('Fish.Kill.Comment'), -contains('Live.Fish.Desc')) %>%
  mutate(Month = Investigation.Start.Month) %>%
  select(-contains('Investigation.Start.Month'))

```

```{r uploading Thermal/NHD data and transforming Thermal}
Thermal_Metrics <-read.csv("/home/aatill/Till_Thesis/Summer_Research_Work/Data/thermal_metrics.csv") 


NHD_WBIC <-read.csv("/home/aatill/Till_Thesis/Summer_Research_Work/Data/NHD_WBIC.csv")

Thermal_Metrics<- merge(Thermal_Metrics, NHD_WBIC) 
```




```{r tidying Thermal data}
Thermal_Tidy <- Thermal_Metrics%>%
  select(-contains('jas')) %>%
  gather(key="type", value="temperature", starts_with('mean_surf_'),starts_with('mean_bot_'), starts_with('max_surf_'), starts_with('max_bot_')) %>%
  separate(type, into=c('metric', 'depth', 'Month'), sep='_')
  
  
Thermal_Tidy$Month <- str_to_title((Thermal_Tidy$Month)) 


  

```

```{r combining the datasets limited}

MME_With_Thermal <- merge(MME_filtered,Thermal_Tidy, all = FALSE) 

MME_With_Thermal <- distinct(MME_With_Thermal)

```

```{r full combined_data}


combined_data <-merge(MME_With_Thermal,Thermal_Tidy, all = TRUE) 

combined_data <- distinct(combined_data)

```

```{r setting up MME distinction and making dates}

combined_data$MME <-as.factor(ifelse(is.na(combined_data$Min.Kill.Size), 0, 1))

combined_data$Date <- make_date(year=combined_data$Year, month = combined_data$Month)

```

```{r creating restriction and zscores in combined_data_restricted}

combined_data_restricted <-combined_data%>%
  filter(Year>2003& Date < '2014-05-01')


combined_data_restricted$zscore_peak_temp <- (combined_data_restricted$peak_temp - ave(combined_data_restricted$peak_temp,combined_data_restricted$site_id)) / sd(combined_data_restricted$peak_temp)

combined_data_restricted<- combined_data_restricted %>%
  group_by(metric, depth, Month) %>%
  mutate(zscore_temp = (temperature - ave(temperature, site_id))/ sd(temperature)) %>%
  ungroup(metric, depth, Month)



```


```{r final tidying for main data prt 1}

main_data <- combined_data_restricted %>%
  mutate(type = paste(combined_data_restricted $metric,'_', combined_data_restricted $depth, sep = '')) %>%
  mutate(typeZ = paste(type, 'Z', sep = '')) %>%
  select(-metric, -depth) %>%
  distinct() %>%
  spread(key = type, value = temperature) %>%
  spread(key = typeZ, value = zscore_temp)

```

```{r final tidying for main data prt 2}
main_data <- main_data %>%
  group_by(WBIC, site_id, Month, Year, peak_temp) %>% #add cause.category.4 
  summarise(MME = max(as.numeric(MME))-1, Ice_Duration = mean(ice_duration_days, na.rm = TRUE), Schmidt = mean(schmidt_daily_annual_sum, na.rm = TRUE), Variance_After_Ice_30 = mean(coef_var_0.30, na.rm = TRUE), Variance_After_Ice_60 = mean(coef_var_30.60, na.rm = TRUE), Cumulative_Above_0 = mean(gdd_wtr_0c, na.rm = TRUE), Cumulative_Above_5 = mean(gdd_wtr_5c, na.rm = TRUE), Cumulative_Above_10 = mean(gdd_wtr_10c, na.rm = TRUE), Mean_Surf_Temp = max(mean_surf, na.rm = TRUE), Max_Surf_Temp = max(max_surf, na.rm = TRUE), Mean_Bot_Temp = max(mean_bot, na.rm = TRUE), Max_Bot_Temp = max(max_bot, na.rm = TRUE), Mean_Surf_Zscore = max(mean_surfZ, na.rm = TRUE), Max_Surf_Zscore = max(max_surfZ, na.rm = TRUE), Mean_Bot_Zscore = max(mean_botZ, na.rm = TRUE), Max_Bot_Zscore = max(max_botZ, na.rm = TRUE)) %>%
  ungroup() 
```

```{r main data additional variables}

main_data$layer_dif <- main_data$Mean_Surf_Temp - main_data$Max_Bot_Temp
main_data$qudratic_temp <- main_data$Mean_Surf_Temp^2 
main_data$Spring <- ifelse(main_data$Month == 'Mar' | main_data$Month == 'Apr' | main_data$Month == 'May', 1, 0)
```

```{r importing spatial data}
dsn <- "/home/aatill/Till_Thesis/Summer_Research_Work/Data/lake_shapes"
ogrListLayers(dsn)
spatial <- readOGR(dsn, layer = 'model_lakes')

```
```{r making data frames from spatial data}
shape_coords <- as.data.frame(coordinates(spatial))

frame_shape <- as.data.frame(spatial)

shape_full <- cbind(shape_coords, frame_shape)

```


```{r Merging with main data}

main_data_spatial<- merge(shape_full, main_data, all = FALSE)

```




